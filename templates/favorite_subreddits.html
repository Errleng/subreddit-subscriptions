<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Favorite Subreddits</title>
    <link href="{{ url_for('static', filename='favorite_subreddits.css') }}" rel="stylesheet">
</head>

<body>
<div class="content" id="content">
    <button>Load all</button>
    <template id="subredditTemplate">
        <div id="subredditDiv">
            <h1 id="subredditName"></h1>
            <div id="sortDiv">
                <label for="sortSelect">Choose a sorting type</label>
                <select id="sortSelect" name="sorts">
                    <option value="day">Day</option>
                    <option value="hour">Hour</option>
                    <option value="week">Week</option>
                    <option value="month">Month</option>
                    <option value="year">Year</option>
                    <option value="all">All</option>
                </select>
            </div>
        </div>
    </template>
    <template id="postTemplate">
        <div>
            <div id="postDiv">
                <a href="" id="postAnchor" rel="noopener noreferrer" target="_blank"></a>
                <br>
                <hr>
            </div>
            <div id="imageDiv">
                <br>
                <a href="" id="imageAnchor" rel="noopener noreferrer" target="_blank"><img alt="Error loading image"
                                                                                           id="imageEmbed" src=""></a>
                <br>
            </div>
            <div id="mediaDiv">
            </div>
            <br>
        </div>
    </template>
</div>
<div id="sentinel"></div>
</body>

<script>
    // declare constants
    const SUBREDDIT_MAX_POSTS = 10;
    const POST_STEP = SUBREDDIT_MAX_POSTS;

    // declare global variables
    let content = document.getElementById("content");
    let sentinel = document.getElementById("sentinel");
    let subredditTemplate = document.getElementById("subredditTemplate");
    let postTemplate = document.getElementById("postTemplate");

    // initialize intersection observer
    let intersectionOptions = {
        // rootMargin: "100%"
    };
    let intersectionObserver = new IntersectionObserver(intersectionCallback, intersectionOptions);
    intersectionObserver.observe(sentinel);

    function intersectionCallback(entries) {
        if (entries[0].intersectionRatio > 0) {
            // get last subreddit
            let subreddits = document.querySelectorAll("div[id^='subreddit_']");

            if (subreddits.length > 0) {
                console.log('subreddits exist');
                // subreddits exist
                let lastSubreddit = subreddits[subreddits.length - 1];
                let lastSubredditPostCount = lastSubreddit.querySelectorAll("div[id^='post_']").length;

                console.log(subreddits, lastSubreddit, lastSubredditPostCount);

                // check if subreddit is finished loading
                let completionIndicator = lastSubreddit.querySelector("div#subredditDone");
                if (completionIndicator === undefined) {
                    // subreddit not done loading
                    let advanceAmount = Math.min(POST_STEP, SUBREDDIT_MAX_POSTS - lastSubredditPostCount);
                    load(subreddits.length - 1, advanceAmount);
                } else {
                    // load new subreddit
                    load(subreddits.length, POST_STEP);
                }
            } else {
                console.log('first subreddit');
                // load first subreddit
                load(0, POST_STEP);
            }
        }
    }

    function load(subredditIndex, postAmount) {
        // loads subreddits, by creating a new one or adding posts to an existing one

        console.log('load', subredditIndex, postAmount);

        let subreddit = document.querySelector(`#subreddit_${subredditIndex}`);
        if (subreddit === null) {
            // subreddit does not exist, create it
            console.log('creating new subreddit');
            loadSubreddit(subredditIndex, postAmount);
        } else {
            // subreddit does exist, load posts if not finished loading
            let completionIndicator = subreddit.querySelector("div#subredditDone");
            if (completionIndicator === undefined) {
                // subreddit not finished loading
                let subredditPosts = subreddit.querySelectorAll("div[id^='post_']");
                let postIndex = subredditPosts.length;

                console.log('loading in progress');
                loadPosts(subredditIndex - 1, postIndex, postAmount);
            }
        }
    }

    function loadSubreddit(subredditIndex, postAmount, callback) {
        const AJAX_URL = "favorites";

        console.log('load subreddit', subredditIndex);

        // request subreddit name and create subreddit div
        let request = new XMLHttpRequest();
        request.open("POST", AJAX_URL);
        request.setRequestHeader("Content-Type", "application/json");
        request.onreadystatechange = function () {
            if (request.readyState === 4 && request.status === 200) {
                let subredditTemplateClone = subredditTemplate.content.cloneNode(true);
                let data = JSON.parse(request.response);

                let subredditDiv = subredditTemplateClone.querySelector("#subredditDiv");

                // set subreddit heading
                let subredditNameHeading = subredditDiv.querySelector("#subredditName");
                subredditNameHeading.innerHTML = data["subreddit_name"];

                // set sort type
                let sortSelectElement = subredditDiv.querySelector("#sortDiv");
                sortSelectElement.addEventListener("change", (event) => {
                    // remove current subreddit posts and reload

                    // get subreddit info
                    let subredditDiv = sortSelectElement.parentNode;
                    let subredditIndex = parseInt(subredditDiv.id.match(/\d+$/)[0]);

                    console.log(`Sort ${event.target.value} for subreddit #${subredditIndex}`);

                    // remove old posts
                    let posts = subredditDiv.querySelectorAll("div[id^='post_']");

                    // load new posts
                    loadPosts(subredditIndex, 0, SUBREDDIT_MAX_POSTS, () => {
                        console.log('removed posts', posts);
                        posts.forEach((post) => {
                            post.parentNode.removeChild(post);
                        });
                    });
                });

                subredditDiv.id = "subreddit_" + subredditIndex;
                content.appendChild(subredditDiv);

                console.log(data['subreddit_name']);

                loadPosts(subredditIndex, 0, postAmount);

                if (callback !== undefined) {
                    callback();
                }
            }
        };

        let requestContent = JSON.stringify({
            subredditIndex: subredditIndex
        });

        request.send(requestContent);
    }

    function loadPosts(subredditIndex, postIndex, postAmount, callback) {
        console.log('load posts', subredditIndex, postIndex, postAmount);
        const AJAX_URL = "favorites";

        // find the subreddit to load posts in
        let subredditDiv = document.querySelector(`#subreddit_${subredditIndex}`);

        // request post data
        let request = new XMLHttpRequest();
        request.open("POST", AJAX_URL);
        request.setRequestHeader("Content-Type", "application/json");
        request.onreadystatechange = function () {
            if (request.readyState === 4 && request.status === 200) {
                let responseJSON = JSON.parse(request.response);
                for (let postCount = 0; postCount < responseJSON.length; ++postCount) {
                    let data = responseJSON[postCount];

                    // create post div in subreddit div
                    let postId = "post_" + postCount;
                    let postDiv = document.createElement("div");
                    postDiv.id = postId;
                    subredditDiv.appendChild(postDiv);

                    // clone post template
                    let postTemplateClone = postTemplate.content.cloneNode(true);

                    // add basic post information
                    let postAnchor = postTemplateClone.querySelector("#postAnchor");
                    postAnchor.href = data["shortlink"];
                    postAnchor.innerHTML = `${data["title"]}<br>(${data["score"]}, ${data["upvote_ratio"]}%) (${data["elapsed_time"]})`;

                    // check and add post preview image
                    if (data.hasOwnProperty("image_preview")) {
                        let imageAnchor = postTemplateClone.querySelector("#imageAnchor");
                        imageAnchor.href = data["shortlink"];
                        let imageEmbed = postTemplateClone.querySelector("#imageEmbed");
                        imageEmbed.src = data["image_preview"];
                    } else {
                        let imageDiv = postTemplateClone.querySelector("#imageDiv");
                        imageDiv.parentNode.removeChild(imageDiv);
                    }

                    // check and add post media
                    if (data.hasOwnProperty("media_preview")) {
                        let mediaDiv = postTemplateClone.querySelector("#mediaDiv");
                        mediaDiv.innerHTML = data["media_preview"];
                    } else {
                        let mediaDiv = postTemplateClone.querySelector("#mediaDiv");
                        mediaDiv.parentNode.removeChild(mediaDiv);
                    }

                    postDiv.appendChild(postTemplateClone);
                }

                // check if completed by testing if max posts is reached or less posts are returned than expected
                if (postIndex + postAmount >= SUBREDDIT_MAX_POSTS || responseJSON.length < postAmount) {
                    let completionIndicator = document.createElement("div");
                    completionIndicator.id = "subredditDone";
                    subredditDiv.appendChild(completionIndicator);
                }

                // do callback if passed in
                if (callback !== undefined) {
                    callback();
                }
            }
        };

        let requestContent = JSON.stringify({
            subredditIndex: subredditIndex,
            postIndex: postIndex,
            postAmount: postAmount,
            sortType: (() => {
                let sortSelectElement = subredditDiv.querySelector("#sortSelect");
                if (sortSelectElement === null) {
                    return "day";
                } else {
                    return sortSelectElement.options[sortSelectElement.selectedIndex].value
                }
            })()
        });

        request.send(requestContent);
    }

    const loadAllButton = document.querySelector('button');
    loadAllButton.addEventListener('click', event => {
        let subreddits = document.querySelectorAll("div[id^='subreddit_']");
        let subredditIndex = subreddits.length;
        loadSubreddit(subredditIndex, SUBREDDIT_MAX_POSTS, function loadSubredditRecursive() {
            let subreddits = document.querySelectorAll("div[id^='subreddit_']");
            let subredditIndex = subreddits.length;
            loadSubreddit(subredditIndex, SUBREDDIT_MAX_POSTS, loadSubredditRecursive);
        });
    });
</script>

</html>